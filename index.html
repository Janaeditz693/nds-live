<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NDS LIVE</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Cinzel:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-black: #000000;
            --card-grey: #121212;
            --input-bg: #1a1a1a;
            --input-border: #333333;
            --text-white: #ffffff;
            --text-grey: #888888;
            --brand-gold: #ffc107;
            --danger-red: #ff4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-black);
            color: var(--text-white);
            font-family: 'Inter', sans-serif;
            padding-bottom: 80px;
        }

        /* --- HEADER --- */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 20px; background: var(--bg-black); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #111;
        }
        .logo { font-family: 'Cinzel', serif; font-size: 24px; color: var(--brand-gold); text-transform: uppercase; }
        .lang-btn { 
            border: 1px solid var(--brand-gold); color: var(--brand-gold); padding: 5px 12px; 
            border-radius: 4px; font-size: 13px; background: transparent; margin-right: 15px; 
            cursor: pointer; font-weight: bold;
        }
        .profile-icon { width: 35px; height: 35px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; font-size: 14px; }
        .profile-icon.active { background: var(--brand-gold); color: #000; }

        /* --- CARDS & FEED --- */
        .feed-container { padding: 0 15px; min-height: 50vh; }
        .card { background-color: var(--card-grey); border-radius: 12px; padding: 15px; margin-bottom: 20px; border: 1px solid #222; }
        
        /* Header */
        .card-header { display: flex; gap: 12px; margin-bottom: 12px; align-items: center; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; color: #000; }
        .avatar.nds { background: var(--brand-gold); } 
        .avatar.user { background: #fff; } 
        .user-info h4 { font-size: 16px; font-weight: 700; color: #fff; margin-bottom: 2px; }
        .user-info span { font-size: 13px; color: var(--text-grey); display: block; }
        
        /* Content */
        .card-content img, .card-content video { width: 100%; border-radius: 8px; margin-top: 5px; max-height: 450px; object-fit: cover; cursor: pointer; }
        .live-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 15px; padding-top: 10px; border-top: 1px solid #222; }
        .bull-name { color: var(--brand-gold); font-size: 20px; font-weight: 700; text-transform: uppercase; font-family: 'Cinzel', serif; }
        .bull-time { color: #fff; font-size: 42px; font-weight: 300; line-height: 1; }
        .bull-time small { font-size: 20px; font-weight: 400; color: #888; }
        
        .card-desc { color: #ddd; font-size: 14px; margin-top: 10px; line-height: 1.5; white-space: pre-wrap; }
        .read-more-btn { color: var(--brand-gold); font-size: 12px; font-weight: bold; cursor: pointer; margin-left: 5px; }

        /* --- SOCIAL INTERACTIONS --- */
        .card-social {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 15px; padding-top: 12px; border-top: 1px solid #222;
        }
        .social-btn {
            background: none; border: none; color: var(--text-grey); 
            font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 6px;
            transition: color 0.2s;
        }
        .social-btn:hover { color: #fff; }
        .social-btn.liked { color: var(--danger-red); }
        .social-btn i { font-size: 18px; }

        /* Comments Section */
        .comments-section {
            margin-top: 15px; padding-top: 10px; border-top: 1px dashed #333; display: none;
        }
        .comments-section.open { display: block; }
        .comment-item { font-size: 13px; color: #ccc; margin-bottom: 8px; }
        .comment-item b { color: var(--brand-gold); margin-right: 5px; }
        .comment-input-box { display: flex; gap: 10px; margin-top: 10px; }
        .comment-input {
            flex: 1; background: #222; border: none; padding: 8px 12px; border-radius: 20px; color: #fff; font-size: 13px; outline: none;
        }
        .comment-send {
            background: var(--brand-gold); color: #000; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* --- LAYOUT UTILS --- */
        .profile-hero { text-align: center; padding: 30px 20px; background: var(--card-grey); margin-bottom: 20px; border-bottom: 1px solid #222; }
        .profile-big-avatar { width: 80px; height: 80px; background: var(--brand-gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; font-weight: bold; color: #000; margin: 0 auto 15px auto; }
        .profile-name { font-size: 24px; font-weight: bold; color: #fff; margin-bottom: 5px; }
        .profile-meta { color: var(--text-grey); font-size: 14px; margin-bottom: 20px; }
        .btn-logout { background: #333; color: #fff; border: 1px solid #444; padding: 8px 20px; border-radius: 20px; font-size: 12px; cursor: pointer; }

        .auth-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 70vh; padding: 20px; }
        .auth-card { background: var(--card-grey); padding: 30px; border-radius: 12px; border: 1px solid #222; width: 100%; max-width: 400px; text-align: center; }
        
        .admin-input-group { margin-bottom: 15px; }
        input, textarea, select { width: 100%; background: var(--input-bg); border: 1px solid var(--input-border); color: #fff; padding: 15px; border-radius: 8px; font-size: 14px; outline: none; font-family: 'Inter', sans-serif; }
        
        /* --- ADMIN STYLES --- */
        .admin-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; }
        .admin-title { font-size: 24px; font-weight: 800; color: #fff; }
        .exit-btn { color: #fff; font-size: 14px; text-decoration: none; cursor: pointer; }
        .admin-tabs { display: flex; background: #111; border-radius: 8px; margin: 0 20px 20px 20px; padding: 4px; border: 1px solid #222; }
        .admin-tab { flex: 1; text-align: center; padding: 10px; color: #888; font-size: 14px; font-weight: 600; cursor: pointer; border-radius: 6px; }
        .admin-tab.active { background: var(--brand-gold); color: #000; }
        .admin-card { background: var(--card-grey); margin: 0 20px 20px 20px; padding: 20px; border-radius: 12px; border: 1px solid #222; }
        .admin-form-container { display: none; }
        .admin-form-container.active { display: block; }
        .file-input-wrapper { position: relative; margin-bottom: 15px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 8px; padding: 10px; display: flex; align-items: center; }
        input[type="file"] { position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .file-custom-btn { background: #fff; color: #000; padding: 6px 12px; border-radius: 4px; font-size: 13px; margin-right: 10px; font-weight: 600; }
        .file-name { color: #fff; font-size: 14px; font-weight: 500; }
        .btn-save { width: 100%; background: var(--brand-gold); color: #000; border: none; padding: 15px; font-weight: 800; font-size: 16px; border-radius: 8px; cursor: pointer; margin-bottom: 10px; }
        .btn-cancel { width: 100%; background: #333; color: #fff; border: none; padding: 10px; font-weight: 600; border-radius: 8px; cursor: pointer; display: none; }

        /* Existing Items List */
        .existing-section { margin: 20px; border-top: 1px solid #333; padding-top: 20px; }
        .existing-title { color: var(--brand-gold); font-size: 18px; font-weight: 800; margin-bottom: 15px; }
        .existing-item { display: flex; align-items: center; justify-content: space-between; background: #000; border: 1px solid #333; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .existing-thumb { width: 50px; height: 50px; border-radius: 4px; object-fit: cover; margin-right: 15px; background: #222; }
        .existing-info { flex: 1; }
        .existing-name { display: block; color: #fff; font-weight: 600; font-size: 14px; }
        .existing-meta { display: block; color: #666; font-size: 12px; margin-top: 2px; text-transform: uppercase; }
        .action-buttons { display: flex; gap: 8px; }
        .btn-action { padding: 6px 12px; border-radius: 4px; border: none; font-weight: bold; font-size: 12px; cursor: pointer; }
        .btn-edit { background: #333; color: #fff; border: 1px solid #444; }
        .btn-del { background: var(--danger-red); color: #fff; }

        /* --- MODALS & LIGHTBOX --- */
        .fab { position: fixed; bottom: 80px; right: 20px; width: 55px; height: 55px; background-color: var(--brand-gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #000; cursor: pointer; z-index: 90; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: #111; padding: 25px; border-radius: 12px; width: 90%; max-width: 350px; border: 1px solid var(--brand-gold); max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 20px; font-weight: bold; color: var(--brand-gold); margin-bottom: 20px; text-transform: uppercase; text-align: center; }
        .lightbox-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: none; justify-content: center; align-items: center; z-index: 3000; }
        .lightbox-content { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        .lightbox-close { position: absolute; top: 20px; right: 20px; color: #fff; font-size: 30px; cursor: pointer; z-index: 3001; background: rgba(0,0,0,0.5); width: 40px; height: 40px; border-radius: 50%; text-align: center; line-height: 40px; }

        /* --- NAV --- */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background-color: #000; border-top: 1px solid #222; display: flex; justify-content: space-around; padding: 10px 0; z-index: 100; user-select: none; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-grey); font-size: 10px; gap: 5px; cursor: pointer; background: none; border: none; }
        .nav-item.active { color: var(--brand-gold); }
        .sub-tab-container { display: flex; background: #111; margin: 0 15px 15px 15px; border-radius: 8px; padding: 4px; border: 1px solid #333; }
        .sub-tab-btn { flex: 1; padding: 10px; background: transparent; color: #777; border: none; cursor: pointer; border-radius: 6px; font-weight: 600; font-size: 13px; }
        .sub-tab-btn.active { background: var(--brand-gold); color: #000; }

        .page-section, .sub-content { display: none; }
        .page-section.active, .sub-content.active { display: block; }
        .user-form-section { display: none; }
        .user-form-section.active { display: block; }
    </style>
</head>
<body>

    <header>
        <div class="logo">NDS LIVE</div>
        <div style="display:flex; align-items:center;">
            <button class="lang-btn" onclick="toggleLanguage()" id="lang-btn">தமிழ்</button>
            <div class="profile-icon" id="header-profile" onclick="handleProfileClick()"><i class="fas fa-user"></i></div>
        </div>
    </header>

    <div id="page-home" class="page-section active">
        <h2 style="padding:15px 20px; font-size:24px; font-weight:800;" data-key="feed_title">Today's Feed</h2>
        <div class="feed-container" id="feed-stream"></div>
    </div>

    <div id="page-live" class="page-section">
        <div class="sub-tab-container">
            <button class="sub-tab-btn active" onclick="switchSubTab('live', 'status')" data-key="tab_status">Live Status</button>
            <button class="sub-tab-btn" onclick="switchSubTab('live', 'video')" data-key="tab_video">Live Video</button>
        </div>
        <div id="live-status-content" class="sub-content active feed-container"><div id="list-live-status"></div></div>
        <div id="live-video-content" class="sub-content feed-container"><div id="list-live-video"></div></div>
    </div>

    <div id="page-events" class="page-section">
        <div class="sub-tab-container">
            <button class="sub-tab-btn active" onclick="switchSubTab('events', 'upcoming')" data-key="tab_upcoming">Upcoming</button>
            <button class="sub-tab-btn" onclick="switchSubTab('events', 'previous')" data-key="tab_previous">Previous Live</button>
        </div>
        <div id="events-upcoming-content" class="sub-content active feed-container"><div id="list-event-upcoming"></div></div>
        <div id="events-previous-content" class="sub-content feed-container"><div id="list-event-previous"></div></div>
    </div>

    <div id="page-profile" class="page-section">
        <div class="profile-hero">
            <div class="profile-big-avatar" id="profile-avatar">U</div>
            <div class="profile-name" id="profile-username">Username</div>
            <div class="profile-meta" data-key="member">Member</div>
            <button class="btn-logout" onclick="handleLogout()" data-key="logout">LOGOUT</button>
        </div>
        <div class="existing-section">
            <div class="existing-title" data-key="my_posts">My Posts</div>
            <div id="profile-posts-list"></div>
        </div>
    </div>

    <div id="page-news" class="page-section">
        <h2 style="padding:15px 20px; font-size:24px; font-weight:800;" data-key="news_title">Latest News</h2>
        <div class="feed-container" id="list-news"></div>
    </div>

    <div id="page-admin" class="page-section">
        <div class="admin-header">
            <span class="admin-title">Admin</span>
            <span class="exit-btn" onclick="exitAdmin()">Exit</span>
        </div>
        <div class="admin-tabs">
            <div class="admin-tab active" id="tab-live" onclick="setAdminMode('live', this)">Live</div>
            <div class="admin-tab" id="tab-events" onclick="setAdminMode('events', this)">Events</div>
            <div class="admin-tab" id="tab-news" onclick="setAdminMode('news', this)">News</div>
        </div>
        <div class="admin-card">
            <input type="hidden" id="admin-current-mode" value="live">
            <input type="hidden" id="edit-post-id" value="">
            <div id="form-live" class="admin-form-container active">
                <div class="file-input-wrapper"><span class="file-custom-btn">File</span><span class="file-name" id="live-file-name">None</span><input type="file" id="live-file" onchange="updateFileName(this, 'live-file-name')"></div>
                <div class="admin-input-group"><input type="text" id="live-name" placeholder="Name"></div>
                <div class="admin-input-group"><input type="text" id="live-village" placeholder="Village"></div>
                <div class="admin-input-group"><input type="text" id="live-time" placeholder="Time (e.g. 5.66)"></div>
                <div class="admin-input-group"><input type="date" id="live-date"></div>
            </div>
            <div id="form-events" class="admin-form-container">
                <div class="file-input-wrapper"><span class="file-custom-btn">File</span><span class="file-name" id="event-file-name">None</span><input type="file" id="event-file" onchange="updateFileName(this, 'event-file-name')"></div>
                <div class="admin-input-group"><input type="text" id="event-name" placeholder="Event Name"></div>
                <div class="admin-input-group"><input type="text" id="event-loc" placeholder="Loc"></div>
                <div class="admin-input-group"><textarea id="event-desc" placeholder="Desc"></textarea></div>
                <div class="admin-input-group"><input type="date" id="event-date"></div>
            </div>
            <div id="form-news" class="admin-form-container">
                <div class="file-input-wrapper"><span class="file-custom-btn">File</span><span class="file-name" id="news-file-name">None</span><input type="file" id="news-file" onchange="updateFileName(this, 'news-file-name')"></div>
                <div class="admin-input-group"><textarea id="news-content" placeholder="Content"></textarea></div>
                <div class="admin-input-group"><input type="date" id="news-date"></div>
            </div>
            <button class="btn-save" id="btn-save-text" onclick="saveAdminPost()">SAVE POST</button>
            <button class="btn-cancel" id="btn-cancel" onclick="cancelEdit()">CANCEL EDIT</button>
        </div>
        <div class="existing-section">
            <div class="existing-title">Manage All Posts</div>
            <div id="admin-items-list"></div>
        </div>
    </div>

    <div id="page-login" class="page-section">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-title" data-key="login_title">Welcome Back</div>
                <div class="admin-input-group"><input type="text" id="login-user" placeholder="Username"></div>
                <div class="admin-input-group"><input type="password" id="login-pass" placeholder="Password"></div>
                <button class="btn-save" onclick="handleLogin()" data-key="login_btn">LOGIN</button>
                <span class="auth-link" onclick="navTo('register', null)" data-key="create_acc">Create New Account</span>
            </div>
        </div>
    </div>
    <div id="page-register" class="page-section">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-title" data-key="reg_title">Create Account</div>
                <div class="admin-input-group"><input type="text" id="reg-user" placeholder="Username"></div>
                <div class="admin-input-group"><input type="password" id="reg-pass" placeholder="Password"></div>
                <button class="btn-save" onclick="handleRegister()" data-key="reg_btn">REGISTER</button>
                <span class="auth-link" onclick="navTo('login', null)" data-key="have_acc">Already have an account? Login</span>
            </div>
        </div>
    </div>

    <div class="fab" onclick="handleFabClick()"><i class="fas fa-plus"></i></div>

    <div id="user-modal" class="modal">
        <div class="modal-content" style="text-align: left;">
            <div class="modal-title" id="user-modal-title" data-key="create_post">Create Post</div>
            <input type="hidden" id="user-edit-id" value="">
            <div class="admin-input-group">
                <select id="user-cat" onchange="updateUserForm()">
                    <option value="live">Live Update</option>
                    <option value="events">Event</option>
                    <option value="news">News</option>
                </select>
            </div>
            <div id="user-form-live" class="user-form-section active">
                <div class="admin-input-group"><input type="text" id="u-live-name" placeholder="Name"></div>
                <div class="admin-input-group"><input type="text" id="u-live-village" placeholder="Village"></div>
                <div class="admin-input-group"><input type="text" id="u-live-time" placeholder="Time (e.g. 5.66)"></div>
            </div>
            <div id="user-form-events" class="user-form-section">
                <div class="admin-input-group"><input type="text" id="u-event-name" placeholder="Event Name"></div>
                <div class="admin-input-group"><input type="text" id="u-event-loc" placeholder="Location"></div>
                <div class="admin-input-group"><textarea id="u-event-desc" placeholder="Details"></textarea></div>
            </div>
             <div id="user-form-news" class="user-form-section">
                <div class="admin-input-group"><textarea id="u-news-content" placeholder="News Content"></textarea></div>
            </div>
            <div class="file-input-wrapper"><span class="file-custom-btn">Image</span><span class="file-name" id="user-file-name">Choose...</span><input type="file" id="user-file" accept="image/*" onchange="updateFileName(this, 'user-file-name')"></div>
            <button class="btn-save" id="btn-user-save" onclick="saveUserPost()" data-key="post_now">POST NOW</button>
            <button class="exit-btn" style="width:100%; text-align:center; margin-top:10px; color:#888;" onclick="closeUserModal()" data-key="cancel">CANCEL</button>
        </div>
    </div>

    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--brand-gold); margin-bottom:15px;">Admin</h3>
            <input type="password" id="admin-password" placeholder="Password" style="width:100%; padding:10px; margin-bottom:10px; background:#222; border:1px solid #333; color:#fff;">
            <button class="btn-save" onclick="checkPassword()">UNLOCK</button>
            <button class="exit-btn" style="display:block; margin-top:15px; width:100%; color:#888;" onclick="closePasswordModal()">CANCEL</button>
        </div>
    </div>
    <div id="lightbox-modal" class="lightbox-modal"><div class="lightbox-close" onclick="closeLightbox()">×</div><div id="lightbox-content" class="lightbox-content"></div></div>

    <nav class="bottom-nav" id="main-nav">
        <button class="nav-item active" onclick="navTo('home', this)">
            <i class="fas fa-home"></i><span data-key="nav_home">HOME</span>
        </button>
        <button class="nav-item" onclick="navTo('live', this)">
            <i class="fas fa-pause-circle"></i><span data-key="nav_live">LIVE</span>
        </button>
        <button class="nav-item" onclick="navTo('events', this)">
            <i class="fas fa-calendar-alt"></i><span data-key="nav_events">EVENTS</span>
        </button>
        <button class="nav-item" onclick="navTo('news', this)">
            <i class="fas fa-newspaper"></i><span data-key="nav_news">NEWS</span>
        </button>
        <button class="nav-item">
            <i class="fas fa-bars"></i><span data-key="nav_more">MORE</span>
        </button>
    </nav>

    <script>
        // --- TRANSLATION LOGIC (REAL TIME) ---
        const translations = {
            en: {
                feed_title: "Today's Feed",
                nav_home: "HOME", nav_live: "LIVE", nav_events: "EVENTS", nav_news: "NEWS", nav_more: "MORE",
                tab_status: "Live Status", tab_video: "Live Video",
                tab_upcoming: "Upcoming", tab_previous: "Previous Live",
                news_title: "Latest News", member: "Member", logout: "LOGOUT", my_posts: "My Posts",
                login_title: "Welcome Back", login_btn: "LOGIN", create_acc: "Create New Account",
                reg_title: "Create Account", reg_btn: "REGISTER", have_acc: "Already have an account? Login",
                create_post: "Create Post", post_now: "POST NOW", cancel: "CANCEL",
                read_more: "Read More", show_less: "Show Less"
            },
            ta: {
                feed_title: "இன்றைய செய்திகள்",
                nav_home: "முகப்பு", nav_live: "நேரலை", nav_events: "நிகழ்வு", nav_news: "செய்தி", nav_more: "மேலும்",
                tab_status: "நேரலை நிலவரம்", tab_video: "நேரலை காணொளி",
                tab_upcoming: "வரவிருக்கும்", tab_previous: "முந்தைய",
                news_title: "சமீபத்திய செய்திகள்", member: "உறுப்பினர்", logout: "வெளியேறு", my_posts: "என் பதிவுகள்",
                login_title: "நல்வரவு", login_btn: "உள்நுழைய", create_acc: "புதிய கணக்கை உருவாக்கு",
                reg_title: "கணக்கு துவங்கு", reg_btn: "பதிவு செய்", have_acc: "ஏற்கனவே கணக்கு உள்ளதா? உள்நுழைய",
                create_post: "பதிவிடவும்", post_now: "பதிவிடு", cancel: "ரத்து செய்",
                read_more: "மேலும் படிக்க", show_less: "சுருக்க"
            }
        };

        let currentLang = localStorage.getItem('nds_lang') || 'en';

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'ta' : 'en';
            localStorage.setItem('nds_lang', currentLang);
            applyLanguage();
        }

        function applyLanguage() {
            // Update Button Text
            document.getElementById('lang-btn').innerText = currentLang === 'en' ? 'தமிழ்' : 'ENG';
            
            // Translate all elements with data-key
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                if(translations[currentLang][key]) {
                    el.innerText = translations[currentLang][key];
                }
            });
            // Re-render feed to translate dynamic content labels
            renderAll();
        }

        function getTrans(key) {
            return translations[currentLang][key] || key;
        }

        // --- APP DATA ---
        let posts = JSON.parse(localStorage.getItem('nds_posts_data') || '[]');
        let currentUser = localStorage.getItem('nds_active_user');
        const today = new Date().toISOString().split('T')[0];
        
        // Init Inputs
        document.getElementById('live-date').value = today;
        document.getElementById('event-date').value = today;
        document.getElementById('news-date').value = today;

        window.onload = function() {
            updateProfileIcon();
            applyLanguage(); // This calls renderAll
        }

        function saveData() { localStorage.setItem('nds_posts_data', JSON.stringify(posts)); }

        // --- AUTH ---
        function updateProfileIcon() {
            const icon = document.getElementById('header-profile');
            if(currentUser) { icon.classList.add('active'); icon.innerHTML = currentUser.charAt(0).toUpperCase(); }
            else { icon.classList.remove('active'); icon.innerHTML = '<i class="fas fa-user"></i>'; }
        }
        function handleProfileClick() {
            if(currentUser) { navTo('profile', null); document.getElementById('profile-username').innerText = currentUser; document.getElementById('profile-avatar').innerText = currentUser.charAt(0).toUpperCase(); renderProfilePosts(); }
            else navTo('login', null);
        }
        function handleLogin() {
            const u = document.getElementById('login-user').value; const p = document.getElementById('login-pass').value;
            let users = JSON.parse(localStorage.getItem('nds_users') || '[]');
            const user = users.find(acc => acc.username === u && acc.password === p);
            if(user) { localStorage.setItem('nds_active_user', u); currentUser = u; updateProfileIcon(); navTo('home', document.querySelector('.nav-item')); } else alert("Invalid Credentials");
        }
        function handleRegister() {
            const u = document.getElementById('reg-user').value; const p = document.getElementById('reg-pass').value;
            if(!u || !p) return alert("Fill fields");
            let users = JSON.parse(localStorage.getItem('nds_users') || '[]');
            users.push({ username: u, password: p }); localStorage.setItem('nds_users', JSON.stringify(users)); alert("Registered!"); navTo('login', null);
        }
        function handleLogout() { localStorage.removeItem('nds_active_user'); currentUser = null; updateProfileIcon(); navTo('home', document.querySelector('.nav-item')); }

        // --- NAV ---
        function navTo(page, btn) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById('page-' + page).classList.add('active');
            if(btn) { document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active')); btn.classList.add('active'); }
            window.scrollTo(0,0);
        }
        function exitAdmin() { cancelEdit(); navTo('home', document.querySelector('.nav-item')); }
        function switchSubTab(parent, sub) {
            document.querySelectorAll(`#page-${parent} .sub-tab-btn`).forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll(`#page-${parent} .sub-content`).forEach(el => el.classList.remove('active'));
            document.getElementById(`${parent}-${sub}-content`).classList.add('active');
        }

        // --- SOCIAL INTERACTIONS ---
        function toggleLike(id) {
            const post = posts.find(p => p.id === id);
            if(post) {
                if(!post.likes) post.likes = 0;
                post.likes++;
                saveData();
                renderAll();
            }
        }
        function sharePost(id) {
            const post = posts.find(p => p.id === id);
            if(navigator.share) {
                navigator.share({ title: 'NDS LIVE', text: `Check out this post by ${post.author}: ${post.title}`, url: window.location.href });
            } else {
                alert("Link copied to clipboard!");
            }
        }
        function toggleComments(id) {
            const el = document.getElementById(`comments-${id}`);
            el.classList.toggle('open');
        }
        function addComment(id) {
            const input = document.getElementById(`comment-input-${id}`);
            const text = input.value;
            if(!text) return;
            const post = posts.find(p => p.id === id);
            if(!post.comments) post.comments = [];
            post.comments.push({ user: currentUser || 'Guest', text: text });
            input.value = '';
            saveData();
            renderAll();
        }

        // --- RENDER ---
        function renderAll() {
            const targets = { 'home': 'feed-stream', 'live_status': 'list-live-status', 'live_video': 'list-live-video', 'events_upcoming': 'list-event-upcoming', 'news_list': 'list-news', 'admin_list': 'admin-items-list' };
            for(let key in targets) document.getElementById(targets[key]).innerHTML = '';

            // Render Home (Chronological)
            posts.forEach(post => renderPostCard(post, 'home'));

            // Render Tabs
            const livePosts = posts.filter(p => p.category === 'live' && p.mediaType !== 'video');
            livePosts.sort((a, b) => (parseFloat(a.time) || 9999) - (parseFloat(b.time) || 9999));
            livePosts.forEach(post => renderPostCard(post, 'live_status'));

            posts.filter(p => p.category === 'live' && p.mediaType === 'video').forEach(p => renderPostCard(p, 'live_video'));
            posts.filter(p => p.category === 'events').forEach(p => renderPostCard(p, 'events_upcoming'));
            posts.filter(p => p.category === 'news').forEach(p => renderPostCard(p, 'news_list'));

            // Admin List
            posts.forEach(post => {
               let thumb = post.mediaType === 'video' ? `<i class="fas fa-video"></i>` : `<img src="${post.mediaSrc}" class="existing-thumb">`;
               document.getElementById('admin-items-list').insertAdjacentHTML('beforeend', `<div class="existing-item"><div style="width:50px; text-align:center">${thumb}</div><div class="existing-info"><span class="existing-name">${post.title}</span><span class="existing-meta">${post.category}</span></div><div class="action-buttons"><button class="btn-action btn-edit" onclick="editAdminPost(${post.id})">EDIT</button><button class="btn-action btn-del" onclick="deletePost(${post.id})">DEL</button></div></div>`);
            });
        }

        function renderPostCard(post, targetKey) {
            let container = null;
            if(targetKey === 'home') container = document.getElementById('feed-stream');
            if(targetKey === 'live_status') container = document.getElementById('list-live-status');
            if(targetKey === 'live_video') container = document.getElementById('list-live-video');
            if(targetKey === 'events_upcoming') container = document.getElementById('list-event-upcoming');
            if(targetKey === 'news_list') container = document.getElementById('list-news');
            if(!container) return;

            // Layout Logic
            let isLiveStatus = (post.category === 'live' && post.mediaType !== 'video');
            let mediaHtml = post.mediaType === 'video' ? `<video src="${post.mediaSrc}" muted onclick="openLightbox('${post.mediaSrc}','video')"></video>` : `<img src="${post.mediaSrc}" onclick="openLightbox('${post.mediaSrc}','image')">`;
            
            const avatarClass = post.isAdmin ? 'nds' : 'user';
            const avatarText = post.isAdmin ? 'N' : post.author.charAt(0).toUpperCase();
            
            // Text Truncate
            let descHtml = '';
            if(post.desc) {
                if(post.desc.length > 100) {
                    const short = post.desc.substring(0, 100) + "...";
                    descHtml = `<div class="card-desc"><span id="desc-short-${post.id}">${short}</span><span id="desc-full-${post.id}" style="display:none">${post.desc}</span><span class="read-more-btn" id="btn-read-${post.id}" onclick="toggleReadMore(${post.id})">${getTrans('read_more')}</span></div>`;
                } else descHtml = `<div class="card-desc">${post.desc}</div>`;
            }

            // Comments HTML
            let commentsHtml = '';
            if(post.comments) {
                post.comments.forEach(c => commentsHtml += `<div class="comment-item"><b>${c.user}:</b>${c.text}</div>`);
            }

            let cardContent = '';
            if (isLiveStatus) {
                let fTime = post.time || "0.00"; if(!fTime.toLowerCase().endsWith('s')) fTime+='s';
                cardContent = `
                <div class="card">
                    <div class="card-header"><div class="avatar ${avatarClass}">${avatarText}</div><div class="user-info"><h4>${post.isAdmin?'NDS LIVE':post.author}</h4><span>${post.village}</span></div></div>
                    <div class="card-content">${mediaHtml}<div class="live-footer"><div class="bull-name">${post.title}</div><div class="bull-time">${fTime}</div></div></div>
                    <div class="card-social">
                        <button class="social-btn" onclick="toggleLike(${post.id})"><i class="far fa-heart"></i> ${post.likes||0}</button>
                        <button class="social-btn" onclick="toggleComments(${post.id})"><i class="far fa-comment"></i> ${post.comments?post.comments.length:0}</button>
                        <button class="social-btn" onclick="sharePost(${post.id})"><i class="fas fa-share"></i> Share</button>
                    </div>
                    <div class="comments-section" id="comments-${post.id}">
                        ${commentsHtml}
                        <div class="comment-input-box"><input type="text" class="comment-input" id="comment-input-${post.id}" placeholder="Write a comment..."><button class="comment-send" onclick="addComment(${post.id})"><i class="fas fa-paper-plane"></i></button></div>
                    </div>
                </div>`;
            } else {
                let meta = "";
                if(post.category === 'events') meta = `${post.village} • ${post.date}`;
                if(post.category === 'news') meta = `${post.date}`;
                if(post.category === 'live' && post.mediaType === 'video') meta = `${post.village} • ${post.time}`;

                cardContent = `
                <div class="card">
                    <div class="card-header"><div class="avatar ${avatarClass}">${avatarText}</div><div class="user-info"><h4>${post.title}</h4><span>${meta}</span></div></div>
                    <div class="card-content">${mediaHtml}${descHtml}</div>
                    <div class="card-social">
                        <button class="social-btn" onclick="toggleLike(${post.id})"><i class="far fa-heart"></i> ${post.likes||0}</button>
                        <button class="social-btn" onclick="toggleComments(${post.id})"><i class="far fa-comment"></i> ${post.comments?post.comments.length:0}</button>
                        <button class="social-btn" onclick="sharePost(${post.id})"><i class="fas fa-share"></i> Share</button>
                    </div>
                    <div class="comments-section" id="comments-${post.id}">
                        ${commentsHtml}
                        <div class="comment-input-box"><input type="text" class="comment-input" id="comment-input-${post.id}" placeholder="Write a comment..."><button class="comment-send" onclick="addComment(${post.id})"><i class="fas fa-paper-plane"></i></button></div>
                    </div>
                </div>`;
            }
            container.insertAdjacentHTML('beforeend', cardContent);
        }

        // (Other logic functions: saveUserPost, saveAdminPost, edit/delete remain same but call saveData() and renderAll())
        // ... (Include previous logic for updateFileName, setAdminMode, toggleReadMore, etc. here) ...
        
        // RE-INCLUDE CORE LOGIC FUNCTIONS TO ENSURE IT WORKS
        function updateFileName(input, displayId) { document.getElementById(displayId).textContent = (input.files && input.files.length > 0) ? input.files[0].name : "None"; }
        function setAdminMode(mode, btn) {
            document.getElementById('admin-current-mode').value = mode; document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            if(btn) btn.classList.add('active'); else document.getElementById('tab-' + mode).classList.add('active');
            document.querySelectorAll('.admin-form-container').forEach(f => f.classList.remove('active')); document.getElementById('form-' + mode).classList.add('active');
        }
        function saveAdminPost() {
            const mode = document.getElementById('admin-current-mode').value; const editId = document.getElementById('edit-post-id').value;
            let post = { category: mode, id: editId ? parseInt(editId) : Date.now(), isAdmin: true, author: 'Admin' };
            let fileInput;
            if (mode === 'live') { post.title=document.getElementById('live-name').value; post.village=document.getElementById('live-village').value; post.time=document.getElementById('live-time').value; post.date=document.getElementById('live-date').value; fileInput=document.getElementById('live-file'); }
            else if (mode === 'events') { post.title=document.getElementById('event-name').value; post.village=document.getElementById('event-loc').value; post.desc=document.getElementById('event-desc').value; post.date=document.getElementById('event-date').value; fileInput=document.getElementById('event-file'); }
            else { post.title="News Update"; post.desc=document.getElementById('news-content').value; post.date=document.getElementById('news-date').value; fileInput=document.getElementById('news-file'); }
            const finalize = (src, type) => {
                post.mediaSrc=src; post.mediaType=type;
                if(editId){ posts[posts.findIndex(p=>p.id==editId)]=post; alert("Updated"); }
                else{ posts.unshift(post); alert("Saved"); }
                cancelEdit(); saveData(); renderAll();
            };
            if(fileInput.files[0]) finalize(URL.createObjectURL(fileInput.files[0]), fileInput.files[0].type.startsWith('video')?'video':'image');
            else if(editId) { const old=posts.find(p=>p.id==editId); finalize(old.mediaSrc, old.mediaType); }
            else finalize('https://via.placeholder.com/400x200', 'image');
        }
        function cancelEdit() { document.getElementById('edit-post-id').value = ""; document.getElementById('btn-save-text').textContent = "SAVE POST"; document.getElementById('btn-cancel').style.display = "none"; document.querySelectorAll('.admin-card input, .admin-card textarea').forEach(e => e.value = ''); }
        function handleFabClick() { if(!currentUser) { if(confirm("Login to post?")) navTo('login', null); } else openUserModal(); }
        function openUserModal(editMode=false) { document.getElementById('user-modal').style.display='flex'; }
        function closeUserModal() { document.getElementById('user-modal').style.display='none'; }
        function updateUserForm() { const cat=document.getElementById('user-cat').value; document.querySelectorAll('.user-form-section').forEach(el=>el.classList.remove('active')); document.getElementById('user-form-'+cat).classList.add('active'); }
        function saveUserPost() {
            const cat = document.getElementById('user-cat').value; const editId = document.getElementById('user-edit-id').value; const fileInput = document.getElementById('user-file');
            let post = { category: cat, isAdmin: false, date: today, author: currentUser };
            if(editId) post.id = parseInt(editId); else post.id = Date.now();
            if(cat === 'live') { post.title = document.getElementById('u-live-name').value; post.village = document.getElementById('u-live-village').value; post.time = document.getElementById('u-live-time').value; }
            else if (cat === 'events') { post.title = document.getElementById('u-event-name').value; post.village = document.getElementById('u-event-loc').value; post.desc = document.getElementById('u-event-desc').value; }
            else { post.title = "User Update"; post.desc = document.getElementById('u-news-content').value; }
            const finalize = (src) => {
                post.mediaSrc = src; post.mediaType = 'image';
                if(editId) { const idx = posts.findIndex(p => p.id == editId); if(idx > -1) { posts[idx] = { ...posts[idx], ...post }; alert("Updated"); } }
                else { posts.unshift(post); alert("Posted!"); }
                closeUserModal(); saveData(); renderAll(); if(document.getElementById('page-profile').classList.contains('active')) renderProfilePosts();
            };
            if (fileInput.files[0]) finalize(URL.createObjectURL(fileInput.files[0]));
            else if(editId) { const old=posts.find(p=>p.id==editId); finalize(old.mediaSrc); }
            else alert("Image Required");
        }
        function renderProfilePosts() {
            const list = document.getElementById('profile-posts-list'); list.innerHTML = ''; const myPosts = posts.filter(p => p.author === currentUser);
            myPosts.forEach(post => {
                list.insertAdjacentHTML('beforeend', `<div class="existing-item"><img src="${post.mediaSrc}" class="existing-thumb"><div class="existing-info"><span class="existing-name">${post.title}</span><span class="existing-meta">${post.category}</span></div><div class="action-buttons"><button class="btn-action btn-del" onclick="deletePost(${post.id}, true)">DEL</button></div></div>`);
            });
        }
        function deletePost(id, user=false) { if(confirm("Delete?")) { posts=posts.filter(p=>p.id!==id); saveData(); renderAll(); if(user) renderProfilePosts(); } }
        function toggleReadMore(id) {
            const short = document.getElementById(`desc-short-${id}`); const full = document.getElementById(`desc-full-${id}`); const btn = document.getElementById(`btn-read-${id}`);
            if(short.style.display === 'none') { short.style.display='inline'; full.style.display='none'; btn.innerText=getTrans('read_more'); }
            else { short.style.display='none'; full.style.display='inline'; btn.innerText=getTrans('show_less'); }
        }
        function openLightbox(src, type) {
            const c=document.getElementById('lightbox-content'); if(type==='video') c.innerHTML=`<video controls autoplay src="${src}" style="max-width:100%; max-height:90vh"></video>`; else c.innerHTML=`<img src="${src}" style="max-width:100%; max-height:90vh">`;
            document.getElementById('lightbox-modal').style.display='flex';
        }
        function closeLightbox() { document.getElementById('lightbox-modal').style.display='none'; document.getElementById('lightbox-content').innerHTML=''; }
        function editAdminPost(id) {
            const p = posts.find(p => p.id === id); navTo('admin', null); setAdminMode(p.category, null);
            document.getElementById('edit-post-id').value = p.id;
            if(p.category === 'live') { document.getElementById('live-name').value = p.title; document.getElementById('live-village').value = p.village; document.getElementById('live-time').value = p.time; }
            else if(p.category === 'events') { document.getElementById('event-name').value = p.title; document.getElementById('event-loc').value = p.village; document.getElementById('event-desc').value = p.desc; }
            else { document.getElementById('news-content').value = p.desc; }
            document.getElementById('btn-save-text').textContent = "UPDATE"; document.getElementById('btn-cancel').style.display = "block"; document.querySelector('.admin-header').scrollIntoView();
        }

        // Security
        let tapCount = 0, tapTimer;
        document.getElementById('main-nav').addEventListener('click', function() {
            tapCount++; clearTimeout(tapTimer); tapTimer = setTimeout(() => { tapCount = 0; }, 800);
            if (tapCount === 5) { document.getElementById('password-modal').style.display = 'flex'; tapCount = 0; }
        });
        function checkPassword() { if(document.getElementById('admin-password').value === 'admin123') { document.getElementById('password-modal').style.display='none'; document.getElementById('admin-password').value=''; navTo('admin', null); } else alert("Incorrect"); }
        function closePasswordModal() { document.getElementById('password-modal').style.display = 'none'; }
    </script>
</body>
</html>
