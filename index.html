<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NDS LIVE | Luxury Edition</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --bg-color: #050505;
            --card-bg: #111111;
            --text-main: #ffffff;
            --text-muted: #888888;
            --accent-gold: #D4AF37;
            --accent-hover: #b5932a;
            --border-color: #333333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        h1, h2, h3, .brand { font-family: 'Cinzel', serif; text-transform: uppercase; letter-spacing: 2px; }

        /* --- Navigation --- */
        nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 40px; background: rgba(5, 5, 5, 0.95);
            border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 1000;
        }
        .brand { color: var(--accent-gold); font-size: 1.5rem; font-weight: 700; }
        .nav-links button {
            background: none; border: none; color: var(--text-muted); margin-left: 30px;
            cursor: pointer; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s;
        }
        .nav-links button:hover, .nav-links button.active { color: var(--accent-gold); }

        /* --- Loading Spinner --- */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 5000;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid var(--accent-gold);
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Layout --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 60px 20px; display: none; animation: fadeIn 0.8s ease; }
        .container.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Cards --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 40px; }
        .card { background: var(--card-bg); border: 1px solid var(--border-color); transition: transform 0.4s ease; position: relative; }
        .card:hover { transform: translateY(-5px); border-color: var(--accent-gold); }
        .card-img-container { width: 100%; height: 250px; overflow: hidden; border-bottom: 1px solid var(--border-color); }
        .card img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.5s ease; }
        .card:hover img { transform: scale(1.05); }
        .card-content { padding: 30px; text-align: center; }
        .card-title { color: var(--accent-gold); font-size: 1.2rem; margin-bottom: 10px; }
        .card-meta { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 5px; }
        .card-desc { margin-top: 15px; font-size: 0.9rem; line-height: 1.6; color: #ccc; }
        
        .delete-btn {
            position: absolute; top: 10px; right: 10px; background: red; color: white;
            border: none; padding: 5px 10px; cursor: pointer; font-size: 12px; display: none; /* Hidden by default */
        }
        .admin-mode .delete-btn { display: block; }

        /* --- Live Hero --- */
        .live-hero {
            position: relative; height: 70vh; display: flex; flex-direction: column; justify-content: center;
            align-items: center; text-align: center; border: 1px solid var(--border-color);
            background-size: cover; background-position: center;
        }
        .overlay { background: linear-gradient(to top, #050505 10%, rgba(5,5,5,0.6)); position: absolute; inset: 0; }
        .live-content { position: relative; z-index: 2; }
        .live-status-badge { background: red; color: white; padding: 5px 15px; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 2px; display: inline-block; margin-bottom: 20px; }

        /* --- Admin/Forms --- */
        .form-box { background: var(--card-bg); padding: 40px; border: 1px solid var(--border-color); max-width: 600px; margin: 0 auto 40px auto; }
        .input-group { margin-bottom: 20px; text-align: left; }
        label { display: block; color: var(--accent-gold); margin-bottom: 10px; font-size: 0.8rem; text-transform: uppercase; }
        input, textarea, select { width: 100%; background: #000; border: 1px solid var(--border-color); padding: 15px; color: #fff; font-family: 'Inter', sans-serif; }
        .btn-gold { background: var(--accent-gold); color: #000; padding: 10px 25px; border: none; font-weight: 600; text-transform: uppercase; cursor: pointer; transition: 0.3s; width: 100%; margin-top: 10px; }
        .btn-gold:hover { background: var(--accent-hover); }
        .hidden { display: none !important; }

        /* --- Login Modal --- */
        .auth-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        
        /* Footer for Secret Admin Tap */
        .secret-footer { text-align: center; padding: 20px; color: #333; font-size: 10px; margin-top: 50px; cursor: pointer; user-select: none; }
    </style>
</head>
<body>

    <div id="loading-overlay"><div class="spinner"></div></div>

    <nav>
        <div class="brand">NDS LIVE</div>
        <div class="nav-links">
            <button onclick="window.switchPage('live')" class="active">Live</button>
            <button onclick="window.switchPage('events')">Events</button>
            <button onclick="window.switchPage('announcements')">Announcements</button>
            <button onclick="window.switchPage('admin')">Profile / Post</button>
            <button onclick="window.logout()" style="color: red;">Logout</button>
        </div>
    </nav>

    <div id="live" class="container active">
        <div id="live-display-area">
            <div class="live-hero">
                <div class="overlay"></div>
                <div class="live-content">
                    <h1>Waiting for Live Updates...</h1>
                </div>
            </div>
        </div>
    </div>

    <div id="events" class="container">
        <h2 style="text-align: center; margin-bottom: 50px; color: var(--accent-gold);">Upcoming Events</h2>
        <div id="events-grid" class="grid"></div>
    </div>

    <div id="announcements" class="container">
        <h2 style="text-align: center; margin-bottom: 50px; color: var(--accent-gold);">Announcements</h2>
        <div id="announcements-grid" class="grid"></div>
    </div>

    <div id="admin" class="container">
        <h2 style="text-align: center; margin-bottom: 30px;">Create Post</h2>
        <p style="text-align: center; color: #666; margin-bottom: 20px;" id="user-display">Logged in as User</p>

        <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 40px;">
            <button class="btn-gold" style="width: auto;" onclick="window.showForm('liveForm')">Update Live</button>
            <button class="btn-gold" style="width: auto;" onclick="window.showForm('eventForm')">Add Event</button>
            <button class="btn-gold" style="width: auto;" onclick="window.showForm('announceForm')">Announcement</button>
        </div>

        <div id="liveForm" class="form-box hidden">
            <h3>Update Live Status</h3>
            <div class="input-group"><input type="text" id="liveName" placeholder="Name / Bull Name"></div>
            <div class="input-group"><input type="text" id="liveVillage" placeholder="Village Name"></div>
            <div class="input-group"><input type="text" id="liveTime" placeholder="Timings (e.g. 5.66s)"></div>
            <div class="input-group"><label>Image</label><input type="file" id="liveImg" accept="image/*"></div>
            <button class="btn-gold" onclick="window.savePost('live')">Publish Live</button>
        </div>

        <div id="eventForm" class="form-box hidden">
            <h3>Create New Event</h3>
            <div class="input-group"><input type="text" id="eventName" placeholder="Event Name"></div>
            <div class="input-group"><input type="text" id="eventVillage" placeholder="Village Name"></div>
            <div class="input-group"><input type="date" id="eventDate"></div>
            <div class="input-group"><label>Image</label><input type="file" id="eventImg" accept="image/*"></div>
            <button class="btn-gold" onclick="window.savePost('events')">Create Event</button>
        </div>

        <div id="announceForm" class="form-box hidden">
            <h3>Post Announcement</h3>
            <div class="input-group"><textarea id="announceDesc" rows="4" placeholder="Description"></textarea></div>
            <div class="input-group"><label>Image</label><input type="file" id="announceImg" accept="image/*"></div>
            <button class="btn-gold" onclick="window.savePost('announcements')">Post</button>
        </div>

        <h3 style="text-align: center; margin-top: 50px; color: var(--accent-gold);">My Recent Posts</h3>
        <div id="my-posts-grid" class="grid" style="margin-top: 20px;"></div>
    </div>

    <div id="authModal" class="auth-modal">
        <div class="form-box">
            <h2 style="color: var(--accent-gold); margin-bottom: 20px; text-align: center;">NDS LOGIN</h2>
            <div class="input-group"><input type="email" id="email" placeholder="Email"></div>
            <div class="input-group"><input type="password" id="password" placeholder="Password"></div>
            <button class="btn-gold" onclick="window.handleLogin()">Login</button>
            <button class="btn-gold" style="background: #333; color: white;" onclick="window.handleRegister()">Register</button>
        </div>
    </div>

    <div id="adminUnlockModal" class="auth-modal hidden">
        <div class="form-box" style="text-align:center;">
            <h3 style="color:red">ADMIN ACCESS</h3>
            <div class="input-group"><input type="password" id="adminPass" placeholder="Admin PIN"></div>
            <button class="btn-gold" onclick="window.checkAdminPin()">UNLOCK</button>
            <button class="btn-gold" style="background:#333; margin-top:10px" onclick="document.getElementById('adminUnlockModal').classList.add('hidden')">CANCEL</button>
        </div>
    </div>

    <div class="secret-footer" onclick="window.handleFooterTap()">
        &copy; 2026 NDS LIVE
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDrYvK2sXIEV2sqppxN0knT-z0OZXdvdCM",
            authDomain: "nds-live-f20e0.firebaseapp.com",
            projectId: "nds-live-f20e0",
            storageBucket: "nds-live-f20e0.firebasestorage.app",
            messagingSenderId: "870905973772",
            appId: "1:870905973772:web:76ca32e380df96906bf229"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/di0fynckd/auto/upload';
        const CLOUDINARY_PRESET = 'imcwyygq';

        let currentUser = null;
        let isAdminUnlocked = false;
        let tapCount = 0;
        let tapTimer;

        // --- AUTH LOGIC ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('authModal').classList.add('hidden');
                document.getElementById('user-display').innerText = `Logged in as: ${user.email}`;
            } else {
                currentUser = null;
                document.getElementById('authModal').classList.remove('hidden');
            }
        });

        // --- EXPORT FUNCTIONS TO WINDOW ---
        window.handleLogin = async () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            try {
                document.getElementById('loading-overlay').style.display = 'flex';
                await signInWithEmailAndPassword(auth, e, p);
                document.getElementById('loading-overlay').style.display = 'none';
            } catch (err) { alert(err.message); document.getElementById('loading-overlay').style.display = 'none'; }
        }

        window.handleRegister = async () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            try {
                document.getElementById('loading-overlay').style.display = 'flex';
                await createUserWithEmailAndPassword(auth, e, p);
                document.getElementById('loading-overlay').style.display = 'none';
                alert("Account created!");
            } catch (err) { alert(err.message); document.getElementById('loading-overlay').style.display = 'none'; }
        }

        window.logout = () => signOut(auth);

        window.switchPage = (pageId) => {
            document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-links button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        window.showForm = (formId) => {
            document.querySelectorAll('.form-box').forEach(el => el.classList.add('hidden'));
            document.getElementById(formId).classList.remove('hidden');
        }

        // --- UPLOAD & SAVE ---
        async function uploadImage(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_PRESET);
            const res = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
            const data = await res.json();
            return data.secure_url;
        }

        window.savePost = async (category) => {
            if (!currentUser) return alert("Please login first");
            
            document.getElementById('loading-overlay').style.display = 'flex';
            let postData = { 
                category: category, 
                author: currentUser.email, 
                timestamp: Date.now(),
                likes: 0
            };

            let fileInput;

            if (category === 'live') {
                postData.name = document.getElementById('liveName').value;
                postData.village = document.getElementById('liveVillage').value;
                postData.time = document.getElementById('liveTime').value;
                fileInput = document.getElementById('liveImg');
            } else if (category === 'events') {
                postData.name = document.getElementById('eventName').value;
                postData.village = document.getElementById('eventVillage').value;
                postData.date = document.getElementById('eventDate').value;
                fileInput = document.getElementById('eventImg');
            } else {
                postData.desc = document.getElementById('announceDesc').value;
                fileInput = document.getElementById('announceImg');
            }

            try {
                if (fileInput.files[0]) {
                    postData.img = await uploadImage(fileInput.files[0]);
                } else {
                    postData.img = "https://via.placeholder.com/400x200?text=No+Image";
                }

                await addDoc(collection(db, "posts"), postData);
                document.getElementById('loading-overlay').style.display = 'none';
                alert("Posted Successfully!");
                window.switchPage(category); // Go to the page to see it
                
                // Clear inputs
                document.querySelectorAll('input').forEach(i => i.value = '');
                document.querySelectorAll('textarea').forEach(i => i.value = '');
            } catch (e) {
                console.error(e);
                alert("Error uploading");
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        window.deletePost = async (id) => {
            if(confirm("Delete this post?")) {
                await deleteDoc(doc(db, "posts", id));
            }
        }

        // --- REAL TIME DATA FETCH ---
        const q = query(collection(db, "posts")); // You can add orderBy here if needed
        onSnapshot(q, (snapshot) => {
            const posts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAll(posts);
        });

        function renderAll(posts) {
            // 1. LIVE HERO (Latest Live Post)
            const livePosts = posts.filter(p => p.category === 'live');
            // Sort by time (low to high for bull run logic) or date? Let's use latest uploaded for hero.
            const latestLive = livePosts.sort((a,b) => b.timestamp - a.timestamp)[0];
            
            if (latestLive) {
                document.getElementById('live-display-area').innerHTML = `
                <div class="live-hero" style="background-image: url('${latestLive.img}');">
                    <div class="overlay"></div>
                    <div class="live-content">
                        <span class="live-status-badge">‚óè Live Now</span>
                        <h1 style="font-size: 3.5rem; margin-bottom: 10px; color: var(--accent-gold);">${latestLive.name}</h1>
                        <h2 style="margin-bottom: 10px;">${latestLive.village}</h2>
                        <p style="font-size: 2rem; letter-spacing: 3px; font-weight:bold;">${latestLive.time}</p>
                        ${(isAdminUnlocked || (currentUser && latestLive.author === currentUser.email)) ? `<button class="btn-gold" style="background:red; width:auto; margin-top:20px;" onclick="window.deletePost('${latestLive.id}')">Delete</button>` : ''}
                    </div>
                </div>`;
            }

            // 2. EVENTS
            const eventsContainer = document.getElementById('events-grid');
            eventsContainer.innerHTML = posts.filter(p => p.category === 'events').map(p => createCard(p)).join('');

            // 3. ANNOUNCEMENTS
            const annContainer = document.getElementById('announcements-grid');
            annContainer.innerHTML = posts.filter(p => p.category === 'announcements').map(p => createCard(p)).join('');

            // 4. MY POSTS (In Admin Tab)
            if(currentUser) {
                const myPosts = posts.filter(p => p.author === currentUser.email);
                document.getElementById('my-posts-grid').innerHTML = myPosts.map(p => createCard(p, true)).join('');
            }
        }

        function createCard(post, isMyPost = false) {
            // Check if user is owner OR admin unlocked
            const canDelete = isMyPost || isAdminUnlocked; 
            
            let content = '';
            if(post.category === 'events') {
                content = `<h3 class="card-title">${post.name}</h3><p class="card-meta">üìç ${post.village}</p><p class="card-meta">üìÖ ${post.date}</p>`;
            } else if (post.category === 'announcements') {
                content = `<p class="card-desc">${post.desc}</p>`;
            } else {
                content = `<h3 class="card-title">${post.name}</h3><p class="card-meta">${post.time}</p>`;
            }

            return `
            <div class="card">
                ${canDelete ? `<button class="delete-btn" onclick="window.deletePost('${post.id}')">DELETE</button>` : ''}
                <div class="card-img-container"><img src="${post.img}"></div>
                <div class="card-content">
                    ${content}
                </div>
            </div>`;
        }

        // --- ADMIN SECURITY ---
        window.handleFooterTap = () => {
            tapCount++;
            clearTimeout(tapTimer);
            tapTimer = setTimeout(() => { tapCount = 0; }, 800);
            if(tapCount === 5) {
                document.getElementById('adminUnlockModal').classList.remove('hidden');
                tapCount = 0;
            }
        }

        window.checkAdminPin = () => {
            const pin = document.getElementById('adminPass').value;
            if(pin === 'admin123') {
                isAdminUnlocked = true;
                document.body.classList.add('admin-mode'); // CSS handles showing delete buttons
                document.getElementById('adminUnlockModal').classList.add('hidden');
                alert("Admin Mode Unlocked: You can delete any post.");
                // Re-render to show delete buttons
                // Need to trigger a re-render manually or wait for snapshot. 
                // Simple trick: Reload page is bad. We can just wait for next update or force it.
                // For now, next snapshot update will show buttons, or user can refresh.
            } else {
                alert("Incorrect PIN");
            }
        }

    </script>
</body>
</html>
