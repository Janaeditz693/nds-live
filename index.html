<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NDS LIVE</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Cinzel:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --bg-black: #000000; --card-grey: #121212; --input-bg: #1a1a1a; --input-border: #333333; --text-white: #ffffff; --text-grey: #888888; --brand-gold: #ffc107; --danger-red: #ff4444; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-black); color: var(--text-white); font-family: 'Inter', sans-serif; padding-bottom: 80px; }
        
        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: var(--bg-black); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #111; }
        .logo { font-family: 'Cinzel', serif; font-size: 24px; color: var(--brand-gold); text-transform: uppercase; }
        .lang-btn { border: 1px solid var(--brand-gold); color: var(--brand-gold); padding: 5px 12px; border-radius: 4px; font-size: 13px; background: transparent; margin-right: 15px; cursor: pointer; font-weight: bold; }
        .profile-icon { width: 35px; height: 35px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; font-size: 14px; }
        .profile-icon.active { background: var(--brand-gold); color: #000; }

        /* LOADING */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 5000; flex-direction: column; }
        .spinner { border: 4px solid #333; border-top: 4px solid var(--brand-gold); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* CARDS */
        .feed-container { padding: 0 15px; min-height: 50vh; }
        .card { background-color: var(--card-grey); border-radius: 12px; padding: 15px; margin-bottom: 20px; border: 1px solid #222; }
        .card-header { display: flex; gap: 12px; margin-bottom: 12px; align-items: center; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; color: #000; }
        .avatar.nds { background: var(--brand-gold); } .avatar.user { background: #fff; }
        .user-info h4 { font-size: 16px; font-weight: 700; color: #fff; margin-bottom: 2px; }
        .user-info span { font-size: 13px; color: var(--text-grey); display: block; }
        .card-content img, .card-content video { width: 100%; border-radius: 8px; margin-top: 5px; max-height: 450px; object-fit: cover; cursor: pointer; }
        
        /* LIVE SPECIFIC */
        .live-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 15px; padding-top: 10px; border-top: 1px solid #222; }
        .bull-name { color: var(--brand-gold); font-size: 20px; font-weight: 700; text-transform: uppercase; font-family: 'Cinzel', serif; }
        .bull-time { color: #fff; font-size: 42px; font-weight: 300; line-height: 1; }
        .bull-time small { font-size: 20px; font-weight: 400; color: #888; }
        
        /* SOCIAL */
        .card-social { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; padding-top: 12px; border-top: 1px solid #222; }
        .social-btn { background: none; border: none; color: var(--text-grey); font-size: 14px; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .social-btn:hover, .social-btn.liked { color: var(--danger-red); }
        .card-desc { color: #ddd; font-size: 14px; margin-top: 10px; line-height: 1.5; white-space: pre-wrap; }
        .read-more-btn { color: var(--brand-gold); font-size: 12px; font-weight: bold; cursor: pointer; margin-left: 5px; }

        /* COMMENTS */
        .comments-section { margin-top: 15px; padding-top: 10px; border-top: 1px dashed #333; display: none; }
        .comments-section.open { display: block; }
        .comment-item { font-size: 13px; color: #ccc; margin-bottom: 8px; }
        .comment-item b { color: var(--brand-gold); margin-right: 5px; }
        .comment-input-box { display: flex; gap: 10px; margin-top: 10px; }
        .comment-input { flex: 1; background: #222; border: none; padding: 8px 12px; border-radius: 20px; color: #fff; font-size: 13px; outline: none; }
        .comment-send { background: var(--brand-gold); color: #000; border: none; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* AUTH & ADMIN */
        .auth-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 70vh; padding: 20px; }
        .auth-card { background: var(--card-grey); padding: 30px; border-radius: 12px; border: 1px solid #222; width: 100%; max-width: 400px; text-align: center; }
        .auth-title { font-size: 24px; font-weight: 800; color: var(--brand-gold); margin-bottom: 20px; }
        .auth-link { color: var(--text-grey); font-size: 14px; margin-top: 15px; display: block; cursor: pointer; }
        
        .admin-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; }
        .admin-title { font-size: 24px; font-weight: 800; color: #fff; }
        .exit-btn { color: #fff; font-size: 14px; text-decoration: none; cursor: pointer; }
        .admin-tabs { display: flex; background: #111; border-radius: 8px; margin: 0 20px 20px 20px; padding: 4px; border: 1px solid #222; }
        .admin-tab { flex: 1; text-align: center; padding: 10px; color: #888; font-size: 14px; font-weight: 600; cursor: pointer; border-radius: 6px; }
        .admin-tab.active { background: var(--brand-gold); color: #000; }
        .admin-card { background: var(--card-grey); margin: 0 20px 20px 20px; padding: 20px; border-radius: 12px; border: 1px solid #222; }
        .admin-input-group { margin-bottom: 15px; }
        input, textarea, select { width: 100%; background: var(--input-bg); border: 1px solid var(--input-border); color: #fff; padding: 15px; border-radius: 8px; font-size: 14px; outline: none; font-family: 'Inter', sans-serif; }
        .btn-save { width: 100%; background: var(--brand-gold); color: #000; border: none; padding: 15px; font-weight: 800; font-size: 16px; border-radius: 8px; cursor: pointer; margin-bottom: 10px; }
        .btn-cancel { width: 100%; background: #333; color: #fff; border: none; padding: 10px; font-weight: 600; border-radius: 8px; cursor: pointer; display: none; }
        
        .existing-section { margin: 20px; border-top: 1px solid #333; padding-top: 20px; }
        .existing-title { color: var(--brand-gold); font-size: 18px; font-weight: 800; margin-bottom: 15px; }
        .existing-item { display: flex; align-items: center; justify-content: space-between; background: #000; border: 1px solid #333; padding: 10px; border-radius: 8px; margin-bottom: 10px; }
        .existing-thumb { width: 50px; height: 50px; border-radius: 4px; object-fit: cover; margin-right: 15px; background: #222; }
        .existing-info { flex: 1; }
        .existing-name { display: block; color: #fff; font-weight: 600; font-size: 14px; }
        .existing-meta { display: block; color: #666; font-size: 12px; margin-top: 2px; text-transform: uppercase; }
        .action-buttons { display: flex; gap: 8px; }
        .btn-action { padding: 6px 12px; border-radius: 4px; border: none; font-weight: bold; font-size: 12px; cursor: pointer; }
        .btn-edit { background: #333; color: #fff; border: 1px solid #444; }
        .btn-del { background: var(--danger-red); color: #fff; }

        /* UTILS */
        .fab { position: fixed; bottom: 80px; right: 20px; width: 55px; height: 55px; background-color: var(--brand-gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #000; cursor: pointer; z-index: 90; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { background: #111; padding: 25px; border-radius: 12px; width: 90%; max-width: 350px; border: 1px solid var(--brand-gold); max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 20px; font-weight: bold; color: var(--brand-gold); margin-bottom: 20px; text-transform: uppercase; text-align: center; }
        .lightbox-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: none; justify-content: center; align-items: center; z-index: 3000; }
        .lightbox-content { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        .lightbox-close { position: absolute; top: 20px; right: 20px; color: #fff; font-size: 30px; cursor: pointer; z-index: 3001; background: rgba(0,0,0,0.5); width: 40px; height: 40px; border-radius: 50%; text-align: center; line-height: 40px; }
        
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background-color: #000; border-top: 1px solid #222; display: flex; justify-content: space-around; padding: 10px 0; z-index: 100; user-select: none; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-grey); font-size: 10px; gap: 5px; cursor: pointer; background: none; border: none; }
        .nav-item.active { color: var(--brand-gold); }
        .sub-tab-container { display: flex; background: #111; margin: 0 15px 15px 15px; border-radius: 8px; padding: 4px; border: 1px solid #333; }
        .sub-tab-btn { flex: 1; padding: 10px; background: transparent; color: #777; border: none; cursor: pointer; border-radius: 6px; font-weight: 600; font-size: 13px; }
        .sub-tab-btn.active { background: var(--brand-gold); color: #000; }

        .page-section, .sub-content, .admin-form-container, .user-form-section { display: none; }
        .page-section.active, .sub-content.active, .admin-form-container.active, .user-form-section.active { display: block; }
        .file-input-wrapper { position: relative; margin-bottom: 15px; background: var(--input-bg); border: 1px solid var(--input-border); border-radius: 8px; padding: 10px; display: flex; align-items: center; }
        input[type="file"] { position: absolute; left: 0; top: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .file-custom-btn { background: #fff; color: #000; padding: 6px 12px; border-radius: 4px; font-size: 13px; margin-right: 10px; font-weight: 600; }
        .file-name { color: #fff; font-size: 14px; font-weight: 500; }
        
        /* Profile Layout */
        .profile-hero { text-align: center; padding: 30px 20px; background: var(--card-grey); margin-bottom: 20px; border-bottom: 1px solid #222; }
        .profile-big-avatar { width: 80px; height: 80px; background: var(--brand-gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; font-weight: bold; color: #000; margin: 0 auto 15px auto; }
        
        /* SECRET FOOTER */
        .secret-footer {
            text-align: center; padding: 20px; color: #333; font-size: 12px; margin-top: 30px; cursor: pointer; user-select: none;
        }
    </style>
</head>
<body>

    <div id="loading-overlay"><div class="spinner"></div><p style="margin-top:10px; color:#fff;">Processing...</p></div>

    <header>
        <div class="logo">NDS LIVE</div>
        <div style="display:flex; align-items:center;">
            <button class="lang-btn" onclick="window.toggleLanguage()" id="lang-btn">தமிழ்</button>
            <div class="profile-icon" id="header-profile" onclick="window.handleProfileClick()"><i class="fas fa-user"></i></div>
        </div>
    </header>

    <div id="page-home" class="page-section active">
        <h2 style="padding:15px 20px; font-size:24px; font-weight:800;" data-key="feed_title">Today's Feed</h2>
        <div class="feed-container" id="feed-stream"></div>
    </div>

    <div id="page-live" class="page-section">
        <div class="sub-tab-container">
            <button class="sub-tab-btn active" onclick="window.switchSubTab('live', 'status')" data-key="tab_status">Live Status</button>
            <button class="sub-tab-btn" onclick="window.switchSubTab('live', 'video')" data-key="tab_video">Live Video</button>
        </div>
        <div id="live-status-content" class="sub-content active feed-container"><div id="list-live-status"></div></div>
        <div id="live-video-content" class="sub-content feed-container"><div id="list-live-video"></div></div>
    </div>

    <div id="page-events" class="page-section">
        <div class="sub-tab-container">
            <button class="sub-tab-btn active" onclick="window.switchSubTab('events', 'upcoming')" data-key="tab_upcoming">Upcoming</button>
            <button class="sub-tab-btn" onclick="window.switchSubTab('events', 'previous')" data-key="tab_previous">Previous Live</button>
        </div>
        <div id="events-upcoming-content" class="sub-content active feed-container"><div id="list-event-upcoming"></div></div>
        <div id="events-previous-content" class="sub-content feed-container"><div id="list-event-previous"></div></div>
    </div>

    <div id="page-news" class="page-section">
        <h2 style="padding:15px 20px; font-size:24px; font-weight:800;" data-key="news_title">Latest News</h2>
        <div class="feed-container" id="list-news"></div>
    </div>

    <div id="page-profile" class="page-section">
        <div class="profile-hero">
            <div class="profile-big-avatar" id="profile-avatar">U</div>
            <div class="profile-name" id="profile-username">Username</div>
            <div class="profile-meta" data-key="member">Member</div>
            <button class="btn-logout" onclick="window.handleLogout()" data-key="logout">LOGOUT</button>
        </div>
        <div class="existing-section">
            <div class="existing-title" data-key="my_posts">My Posts</div>
            <div id="profile-posts-list"></div>
        </div>
        <div class="secret-footer" id="secret-footer-trigger">
            &copy; 2026 NDS LIVE
        </div>
    </div>

    <div id="page-login" class="page-section">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-title" data-key="login_title">Welcome Back</div>
                <div class="admin-input-group"><input type="email" id="login-email" placeholder="Email"></div>
                <div class="admin-input-group"><input type="password" id="login-pass" placeholder="Password"></div>
                <button class="btn-save" onclick="window.handleLogin()" data-key="login_btn">LOGIN</button>
                <span class="auth-link" onclick="window.navTo('register', null)" data-key="create_acc">Create New Account</span>
            </div>
        </div>
    </div>

    <div id="page-register" class="page-section">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-title" data-key="reg_title">Create Account</div>
                <div class="admin-input-group"><input type="text" id="reg-name" placeholder="Name"></div>
                <div class="admin-input-group"><input type="email" id="reg-email" placeholder="Email"></div>
                <div class="admin-input-group"><input type="password" id="reg-pass" placeholder="Password"></div>
                <button class="btn-save" onclick="window.handleRegister()" data-key="reg_btn">REGISTER</button>
                <span class="auth-link" onclick="window.navTo('login', null)" data-key="have_acc">Already have an account? Login</span>
            </div>
        </div>
    </div>

    <div id="page-admin" class="page-section">
        <div class="admin-header"><span class="admin-title">Admin</span><span class="exit-btn" onclick="window.exitAdmin()">Exit</span></div>
        <div class="admin-tabs">
            <div class="admin-tab active" onclick="window.setAdminMode('live', this)">Live</div>
            <div class="admin-tab" onclick="window.setAdminMode('events', this)">Events</div>
            <div class="admin-tab" onclick="window.setAdminMode('news', this)">News</div>
        </div>
        <div class="admin-card">
            <input type="hidden" id="admin-current-mode" value="live">
            <input type="hidden" id="edit-post-id" value="">
            <div id="form-live" class="admin-form-container active">
                <div class="file-input-wrapper"><span class="file-custom-btn">File</span><span class="file-name" id="live-file-name">None</span><input type="file" id="live-file" onchange="window.updateFileName(this, 'live-file-name')"></div>
                <div class="admin-input-group"><input type="text" id="live-name" placeholder="Name"></div>
                <div class="admin-input-group"><input type="text" id="live-village" placeholder="Village"></div>
                <div class="admin-input-group"><input type="text" id="live-time" placeholder="Time (e.g. 5.66)"></div>
                <div class="admin-input-group"><input type="date" id="live-date"></div>
            </div>
            <div id="form-events" class="admin-form-container">
                <div class="file-input-wrapper"><span class="file-custom-btn">File</span><span class="file-name" id="event-file-name">None</span><input type="file" id="event-file" onchange="window.updateFileName(this, 'event-file-name')"></div>
                <div class="admin-input-group"><input type="text" id="event-name" placeholder="Event Name"></div>
                <div class="admin-input-group"><input type="text" id="event-loc" placeholder="Loc"></div>
                <div class="admin-input-group"><textarea id="event-desc" placeholder="Desc"></textarea></div>
                <div class="admin-input-group"><input type="date" id="event-date"></div>
            </div>
            <div id="form-news" class="admin-form-container">
                <div class="file-input-wrapper"><span class="file-custom-btn">File</span><span class="file-name" id="news-file-name">None</span><input type="file" id="news-file" onchange="window.updateFileName(this, 'news-file-name')"></div>
                <div class="admin-input-group"><textarea id="news-content" placeholder="Content"></textarea></div>
                <div class="admin-input-group"><input type="date" id="news-date"></div>
            </div>
            <button class="btn-save" id="btn-save-text" onclick="window.saveAdminPost()">SAVE POST</button>
            <button class="btn-cancel" id="btn-cancel" onclick="window.cancelEdit()">CANCEL</button>
        </div>
        <div class="existing-section"><div class="existing-title">Manage Posts</div><div id="admin-items-list"></div></div>
    </div>

    <div class="fab" onclick="window.handleFabClick()"><i class="fas fa-plus"></i></div>

    <div id="user-modal" class="modal">
        <div class="modal-content" style="text-align:left;">
            <div class="modal-title" data-key="create_post">Create Post</div>
            <input type="hidden" id="user-edit-id" value="">
            <div class="admin-input-group"><select id="user-cat" onchange="window.updateUserForm()"><option value="live">Live Update</option><option value="events">Event</option><option value="news">News</option></select></div>
            <div id="user-form-live" class="user-form-section active">
                <div class="admin-input-group"><input type="text" id="u-live-name" placeholder="Name"></div>
                <div class="admin-input-group"><input type="text" id="u-live-village" placeholder="Village"></div>
                <div class="admin-input-group"><input type="text" id="u-live-time" placeholder="Time (e.g. 5.66)"></div>
            </div>
            <div id="user-form-events" class="user-form-section">
                <div class="admin-input-group"><input type="text" id="u-event-name" placeholder="Event Name"></div>
                <div class="admin-input-group"><input type="text" id="u-event-loc" placeholder="Location"></div>
                <div class="admin-input-group"><textarea id="u-event-desc" placeholder="Details"></textarea></div>
            </div>
            <div id="user-form-news" class="user-form-section">
                <div class="admin-input-group"><textarea id="u-news-content" placeholder="Content"></textarea></div>
            </div>
            <div class="file-input-wrapper"><span class="file-custom-btn">Image</span><span class="file-name" id="user-file-name">Choose...</span><input type="file" id="user-file" accept="image/*" onchange="window.updateFileName(this, 'user-file-name')"></div>
            <button class="btn-save" id="btn-user-save" onclick="window.saveUserPost()" data-key="post_now">POST NOW</button>
            <button class="exit-btn" onclick="window.closeUserModal()" data-key="cancel" style="width:100%;color:#888;">CANCEL</button>
        </div>
    </div>

    <div id="password-modal" class="modal">
        <div class="modal-content"><h3 style="color:var(--brand-gold);text-align:center;margin-bottom:10px;">Admin</h3><input type="password" id="admin-password" placeholder="Password" style="width:100%;padding:10px;background:#222;border:1px solid #333;color:#fff;"><button class="btn-save" style="margin-top:10px;" onclick="window.checkPassword()">UNLOCK</button><button class="exit-btn" style="width:100%;margin-top:10px;color:#888;" onclick="window.closePasswordModal()">CANCEL</button></div>
    </div>
    <div id="lightbox-modal" class="lightbox-modal"><div class="lightbox-close" onclick="window.closeLightbox()">×</div><div id="lightbox-content" class="lightbox-content"></div></div>

    <nav class="bottom-nav" id="main-nav">
        <button class="nav-item active" onclick="window.navTo('home', this)"><i class="fas fa-home"></i><span data-key="nav_home">HOME</span></button>
        <button class="nav-item" onclick="window.navTo('live', this)"><i class="fas fa-pause-circle"></i><span data-key="nav_live">LIVE</span></button>
        <button class="nav-item" onclick="window.navTo('events', this)"><i class="fas fa-calendar-alt"></i><span data-key="nav_events">EVENTS</span></button>
        <button class="nav-item" onclick="window.navTo('news', this)"><i class="fas fa-newspaper"></i><span data-key="nav_news">NEWS</span></button>
        <button class="nav-item"><i class="fas fa-bars"></i><span data-key="nav_more">MORE</span></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDrYvK2sXIEV2sqppxN0knT-z0OZXdvdCM",
            authDomain: "nds-live-f20e0.firebaseapp.com",
            projectId: "nds-live-f20e0",
            storageBucket: "nds-live-f20e0.firebasestorage.app",
            messagingSenderId: "870905973772",
            appId: "1:870905973772:web:76ca32e380df96906bf229",
            measurementId: "G-9LFNL56N1Z"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const CLOUDINARY_URL = 'https://api.cloudinary.com/v1_1/di0fynckd/auto/upload';
        const CLOUDINARY_PRESET = 'imcwyygq';

        // STATE
        let posts = [];
        let currentUser = null;
        let currentLang = localStorage.getItem('nds_lang') || 'en';
        const translations = {
            en: { feed_title:"Today's Feed", nav_home:"HOME", nav_live:"LIVE", nav_events:"EVENTS", nav_news:"NEWS", nav_more:"MORE", tab_status:"Live Status", tab_video:"Live Video", tab_upcoming:"Upcoming", tab_previous:"Previous Live", news_title:"Latest News", member:"Member", logout:"LOGOUT", my_posts:"My Posts", login_title:"Welcome Back", login_btn:"LOGIN", create_acc:"Create New Account", reg_title:"Create Account", reg_btn:"REGISTER", have_acc:"Login instead?", create_post:"Create Post", post_now:"POST NOW", cancel:"CANCEL", read_more:"Read More", show_less:"Show Less" },
            ta: { feed_title:"இன்றைய செய்திகள்", nav_home:"முகப்பு", nav_live:"நேரலை", nav_events:"நிகழ்வு", nav_news:"செய்தி", nav_more:"மேலும்", tab_status:"நேரலை நிலவரம்", tab_video:"நேரலை காணொளி", tab_upcoming:"வரவிருக்கும்", tab_previous:"முந்தைய", news_title:"சமீபத்திய செய்திகள்", member:"உறுப்பினர்", logout:"வெளியேறு", my_posts:"என் பதிவுகள்", login_title:"நல்வரவு", login_btn:"உள்நுழைய", create_acc:"புதிய கணக்கை உருவாக்கு", reg_title:"கணக்கு துவங்கு", reg_btn:"பதிவு செய்", have_acc:"உள்நுழைய வேண்டுமா?", create_post:"பதிவிடவும்", post_now:"பதிவிடு", cancel:"ரத்து", read_more:"மேலும் படிக்க", show_less:"சுருக்க" }
        };

        // AUTH
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            updateProfileIcon();
            if(document.getElementById('page-profile').classList.contains('active')) renderProfilePosts();
        });

        // --- GLOBAL EXPORTS ---
        window.handleRegister = async () => {
            const n = document.getElementById('reg-name').value;
            const e = document.getElementById('reg-email').value;
            const p = document.getElementById('reg-pass').value;
            if(!n || !e || !p) return alert("Fill all fields");
            showLoading(true);
            try {
                const cred = await createUserWithEmailAndPassword(auth, e, p);
                await updateProfile(cred.user, { displayName: n });
                showLoading(false); alert("Welcome!"); window.navTo('home', document.querySelector('.nav-item'));
            } catch(err) { showLoading(false); alert(err.message); }
        };

        window.handleLogin = async () => {
            const e = document.getElementById('login-email').value;
            const p = document.getElementById('login-pass').value;
            showLoading(true);
            try {
                await signInWithEmailAndPassword(auth, e, p);
                showLoading(false); window.navTo('home', document.querySelector('.nav-item'));
            } catch(err) { showLoading(false); alert("Invalid Credentials"); }
        };

        window.handleLogout = async () => { await signOut(auth); window.navTo('home', document.querySelector('.nav-item')); };

        // DATABASE
        const q = query(collection(db, "posts")); 
        onSnapshot(q, (snapshot) => {
            posts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAll();
            if(document.getElementById('page-profile').classList.contains('active')) renderProfilePosts();
        });

        async function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', CLOUDINARY_PRESET);
            const res = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
            const data = await res.json();
            return data.secure_url;
        }

        // ADMIN POSTING
        window.saveAdminPost = async () => {
            const mode = document.getElementById('admin-current-mode').value;
            const editId = document.getElementById('edit-post-id').value;
            const fileInput = document.getElementById(mode === 'live' ? 'live-file' : mode === 'events' ? 'event-file' : 'news-file');
            
            let post = { category: mode, isAdmin: true, author: 'Admin', likes:0, timestamp: Date.now() };
            
            if(mode === 'live') {
                post.title = document.getElementById('live-name').value;
                post.village = document.getElementById('live-village').value;
                post.time = document.getElementById('live-time').value;
                post.date = document.getElementById('live-date').value;
            } else if(mode === 'events') {
                post.title = document.getElementById('event-name').value;
                post.village = document.getElementById('event-loc').value;
                post.desc = document.getElementById('event-desc').value;
                post.date = document.getElementById('event-date').value;
            } else {
                post.title = "News Update";
                post.desc = document.getElementById('news-content').value;
                post.date = document.getElementById('news-date').value;
            }

            if(!post.title && !post.desc) return alert("Info missing");
            showLoading(true);

            try {
                if(fileInput.files[0]) {
                    post.mediaSrc = await uploadFile(fileInput.files[0]);
                    post.mediaType = fileInput.files[0].type.startsWith('video') ? 'video' : 'image';
                }

                if(editId) {
                    await updateDoc(doc(db, "posts", editId), post);
                    alert("Updated");
                } else {
                    if(!post.mediaSrc) post.mediaSrc = 'https://via.placeholder.com/400x200?text=No+Image'; // Default
                    await addDoc(collection(db, "posts"), post);
                    alert("Posted");
                }
                window.cancelEdit();
            } catch(e) { console.error(e); alert("Error saving"); }
            showLoading(false);
        };

        window.saveUserPost = async () => {
            const cat = document.getElementById('user-cat').value;
            const editId = document.getElementById('user-edit-id').value;
            const fileInput = document.getElementById('user-file');
            
            let post = { category: cat, isAdmin: false, author: currentUser.displayName || 'User', timestamp: Date.now() };
            if(cat === 'live') {
                post.title = document.getElementById('u-live-name').value;
                post.village = document.getElementById('u-live-village').value;
                post.time = document.getElementById('u-live-time').value;
            } else if(cat === 'events') {
                post.title = document.getElementById('u-event-name').value;
                post.village = document.getElementById('u-event-loc').value;
                post.desc = document.getElementById('u-event-desc').value;
            } else {
                post.title = "User Update";
                post.desc = document.getElementById('u-news-content').value;
            }

            if(!post.title && !post.desc) return alert("Info required");
            showLoading(true);

            try {
                if(fileInput.files[0]) {
                    post.mediaSrc = await uploadFile(fileInput.files[0]);
                    post.mediaType = 'image';
                } else if(!editId) {
                    showLoading(false); return alert("Image required");
                }

                if(editId) {
                    await updateDoc(doc(db, "posts", editId), post);
                    alert("Updated");
                } else {
                    post.likes = 0;
                    await addDoc(collection(db, "posts"), post);
                    alert("Posted");
                }
                window.closeUserModal();
            } catch(e) { console.error(e); alert("Error"); }
            showLoading(false);
        };

        window.deletePost = async (id) => {
            if(confirm("Delete?")) {
                showLoading(true);
                await deleteDoc(doc(db, "posts", id));
                showLoading(false);
            }
        };

        // INTERACTIONS
        window.toggleLike = async (id) => {
            const p = posts.find(x => x.id === id);
            if(p) {
                const newLikes = (p.likes || 0) + 1;
                await updateDoc(doc(db, "posts", id), { likes: newLikes });
            }
        };

        window.sharePost = (id) => {
            const p = posts.find(x => x.id === id);
            if(navigator.share) navigator.share({ title: 'NDS LIVE', text: p.title, url: window.location.href });
            else alert("Link copied!");
        };

        window.toggleComments = (id) => { document.getElementById(`comments-${id}`).classList.toggle('open'); }
        
        window.addComment = async (id) => {
            const input = document.getElementById(`comment-input-${id}`);
            const text = input.value;
            if(!text) return;
            const p = posts.find(x => x.id === id);
            const newComments = p.comments || [];
            newComments.push({ user: currentUser ? currentUser.displayName : 'Guest', text: text });
            await updateDoc(doc(db, "posts", id), { comments: newComments });
            input.value = '';
        };

        window.toggleLanguage = () => {
            currentLang = currentLang === 'en' ? 'ta' : 'en';
            localStorage.setItem('nds_lang', currentLang);
            applyLanguage();
        };

        function applyLanguage() {
            document.getElementById('lang-btn').innerText = currentLang === 'en' ? 'தமிழ்' : 'ENG';
            document.querySelectorAll('[data-key]').forEach(el => {
                const k = el.getAttribute('data-key');
                if(translations[currentLang][k]) el.innerText = translations[currentLang][k];
            });
            renderAll();
        }

        function getTrans(key) { return translations[currentLang][key] || key; }

        function renderAll() {
            const targets = { 'home': 'feed-stream', 'live_status': 'list-live-status', 'live_video': 'list-live-video', 'events_upcoming': 'list-event-upcoming', 'news_list': 'list-news', 'admin_list': 'admin-items-list' };
            for(let key in targets) document.getElementById(targets[key]).innerHTML = '';

            const sortedPosts = [...posts].sort((a,b) => b.timestamp - a.timestamp);

            sortedPosts.forEach(post => renderPostCard(post, 'home'));
            sortedPosts.filter(p => p.category === 'live' && p.mediaType === 'video').forEach(p => renderPostCard(p, 'live_video'));
            sortedPosts.filter(p => p.category === 'events').forEach(p => renderPostCard(p, 'events_upcoming'));
            sortedPosts.filter(p => p.category === 'news').forEach(p => renderPostCard(p, 'news_list'));

            const liveStatus = posts.filter(p => p.category === 'live' && p.mediaType !== 'video');
            liveStatus.sort((a, b) => (parseFloat(a.time) || 9999) - (parseFloat(b.time) || 9999));
            liveStatus.forEach(post => renderPostCard(post, 'live_status'));

            sortedPosts.forEach(post => {
                let thumb = post.mediaType === 'video' ? `<i class="fas fa-video"></i>` : `<img src="${post.mediaSrc}" class="existing-thumb">`;
                document.getElementById('admin-items-list').insertAdjacentHTML('beforeend', `<div class="existing-item"><div style="width:50px;text-align:center;">${thumb}</div><div class="existing-info"><span class="existing-name">${post.title}</span><span class="existing-meta">${post.category}</span></div><div class="action-buttons"><button class="btn-action btn-edit" onclick="window.editAdminPost('${post.id}')">EDIT</button><button class="btn-action btn-del" onclick="window.deletePost('${post.id}')">DEL</button></div></div>`);
            });
        }

        function renderPostCard(post, target) {
            const container = document.getElementById(target === 'home' ? 'feed-stream' : target === 'live_status' ? 'list-live-status' : target === 'live_video' ? 'list-live-video' : target === 'events_upcoming' ? 'list-event-upcoming' : 'list-news');
            if(!container) return;

            let isLiveStatus = (post.category === 'live' && post.mediaType !== 'video');
            let mediaHtml = post.mediaType === 'video' ? `<video src="${post.mediaSrc}" muted onclick="window.openLightbox('${post.mediaSrc}','video')"></video>` : `<img src="${post.mediaSrc}" onclick="window.openLightbox('${post.mediaSrc}','image')">`;
            const avatarClass = post.isAdmin ? 'nds' : 'user';
            const avatarText = post.isAdmin ? 'N' : post.author.charAt(0).toUpperCase();
            
            let descHtml = '';
            if(post.desc) {
                if(post.desc.length > 100) {
                    const short = post.desc.substring(0, 100) + "...";
                    descHtml = `<div class="card-desc"><span id="desc-short-${post.id}">${short}</span><span id="desc-full-${post.id}" style="display:none">${post.desc}</span><span class="read-more-btn" id="btn-read-${post.id}" onclick="window.toggleReadMore('${post.id}')">${getTrans('read_more')}</span></div>`;
                } else descHtml = `<div class="card-desc">${post.desc}</div>`;
            }

            let commentsHtml = '';
            if(post.comments) { post.comments.forEach(c => commentsHtml += `<div class="comment-item"><b>${c.user}:</b>${c.text}</div>`); }

            let cardContent = '';
            if(isLiveStatus) {
                let fTime = post.time || "0.00"; if(!fTime.toLowerCase().endsWith('s')) fTime+='s';
                cardContent = `<div class="card"><div class="card-header"><div class="avatar ${avatarClass}">${avatarText}</div><div class="user-info"><h4>${post.isAdmin?'NDS LIVE':post.author}</h4><span>${post.village}</span></div></div><div class="card-content">${mediaHtml}<div class="live-footer"><div class="bull-name">${post.title}</div><div class="bull-time">${fTime}</div></div></div><div class="card-social"><button class="social-btn" onclick="window.toggleLike('${post.id}')"><i class="far fa-heart"></i> ${post.likes||0}</button><button class="social-btn" onclick="window.toggleComments('${post.id}')"><i class="far fa-comment"></i> ${post.comments?post.comments.length:0}</button><button class="social-btn" onclick="window.sharePost('${post.id}')"><i class="fas fa-share"></i> Share</button></div><div class="comments-section" id="comments-${post.id}">${commentsHtml}<div class="comment-input-box"><input type="text" class="comment-input" id="comment-input-${post.id}" placeholder="Write a comment..."><button class="comment-send" onclick="window.addComment('${post.id}')"><i class="fas fa-paper-plane"></i></button></div></div></div>`;
            } else {
                let meta = post.category === 'events' ? `${post.village} • ${post.date}` : post.category === 'news' ? post.date : `${post.village} • ${post.time}`;
                cardContent = `<div class="card"><div class="card-header"><div class="avatar ${avatarClass}">${avatarText}</div><div class="user-info"><h4>${post.title}</h4><span>${meta}</span></div></div><div class="card-content">${mediaHtml}${descHtml}</div><div class="card-social"><button class="social-btn" onclick="window.toggleLike('${post.id}')"><i class="far fa-heart"></i> ${post.likes||0}</button><button class="social-btn" onclick="window.toggleComments('${post.id}')"><i class="far fa-comment"></i> ${post.comments?post.comments.length:0}</button><button class="social-btn" onclick="window.sharePost('${post.id}')"><i class="fas fa-share"></i> Share</button></div><div class="comments-section" id="comments-${post.id}">${commentsHtml}<div class="comment-input-box"><input type="text" class="comment-input" id="comment-input-${post.id}" placeholder="Write a comment..."><button class="comment-send" onclick="window.addComment('${post.id}')"><i class="fas fa-paper-plane"></i></button></div></div></div>`;
            }
            container.insertAdjacentHTML('beforeend', cardContent);
        }

        function renderProfilePosts() {
            const list = document.getElementById('profile-posts-list'); list.innerHTML = '';
            if(!currentUser) return;
            const myPosts = posts.filter(p => p.author === currentUser.displayName || (p.isAdmin && currentUser.email === 'admin@nds.com'));
            myPosts.forEach(post => {
                let thumb = post.mediaType === 'video' ? `<i class="fas fa-video"></i>` : `<img src="${post.mediaSrc}" class="existing-thumb">`;
                list.insertAdjacentHTML('beforeend', `<div class="existing-item"><div style="width:50px;text-align:center;">${thumb}</div><div class="existing-info"><span class="existing-name">${post.title}</span><span class="existing-meta">${post.category}</span></div><div class="action-buttons"><button class="btn-action btn-del" onclick="window.deletePost('${post.id}')">DEL</button></div></div>`);
            });
        }

        // EXPORTS & HELPERS
        window.navTo = (p, b) => { document.querySelectorAll('.page-section').forEach(e=>e.classList.remove('active')); document.getElementById('page-'+p).classList.add('active'); if(b){ document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); b.classList.add('active'); } window.scrollTo(0,0); };
        window.switchSubTab = (p, s) => { document.querySelectorAll(`#page-${p} .sub-tab-btn`).forEach(b=>b.classList.remove('active')); event.target.classList.add('active'); document.querySelectorAll(`#page-${p} .sub-content`).forEach(e=>e.classList.remove('active')); document.getElementById(`${p}-${s}-content`).classList.add('active'); };
        window.updateFileName = updateFileName;
        window.setAdminMode = (m, b) => { document.getElementById('admin-current-mode').value=m; document.querySelectorAll('.admin-tab').forEach(t=>t.classList.remove('active')); b.classList.add('active'); document.querySelectorAll('.admin-form-container').forEach(f=>f.classList.remove('active')); document.getElementById('form-'+m).classList.add('active'); };
        window.editAdminPost = (id) => { const p=posts.find(x=>x.id===id); window.navTo('admin',null); window.setAdminMode(p.category, document.querySelector(`.admin-tab:nth-child(${p.category=='live'?1:p.category=='events'?2:3})`)); document.getElementById('edit-post-id').value=id; if(p.category=='live'){document.getElementById('live-name').value=p.title;document.getElementById('live-village').value=p.village;document.getElementById('live-time').value=p.time;} else if(p.category=='events'){document.getElementById('event-name').value=p.title;document.getElementById('event-loc').value=p.village;document.getElementById('event-desc').value=p.desc;} else{document.getElementById('news-content').value=p.desc;} document.getElementById('btn-save-text').innerText="UPDATE"; document.getElementById('btn-cancel').style.display='block'; };
        window.cancelEdit = () => { document.getElementById('edit-post-id').value=""; document.getElementById('btn-save-text').innerText="SAVE POST"; document.getElementById('btn-cancel').style.display='none'; document.querySelectorAll('.admin-card input,.admin-card textarea').forEach(i=>i.value=''); };
        window.handleFabClick = () => { if(!currentUser) {if(confirm("Login?")) window.navTo('login',null);} else document.getElementById('user-modal').style.display='flex'; };
        window.closeUserModal = () => document.getElementById('user-modal').style.display='none';
        window.updateUserForm = () => { const c=document.getElementById('user-cat').value; document.querySelectorAll('.user-form-section').forEach(e=>e.classList.remove('active')); document.getElementById('user-form-'+c).classList.add('active'); };
        window.checkPassword = () => { if(document.getElementById('admin-password').value==='admin123'){document.getElementById('password-modal').style.display='none';window.navTo('admin',null);}else alert("Incorrect"); };
        window.closePasswordModal = () => document.getElementById('password-modal').style.display='none';
        window.exitAdmin = () => { window.cancelEdit(); window.navTo('home', document.querySelector('.nav-item')); };
        window.openLightbox = (s,t) => { const c=document.getElementById('lightbox-content'); if(t=='video') c.innerHTML=`<video src="${s}" controls autoplay style="max-width:100%;max-height:90vh;"></video>`; else c.innerHTML=`<img src="${s}" style="max-width:100%;max-height:90vh;">`; document.getElementById('lightbox-modal').style.display='flex'; };
        window.closeLightbox = () => { document.getElementById('lightbox-modal').style.display='none'; document.getElementById('lightbox-content').innerHTML=''; };
        window.toggleReadMore = (id) => { const s=document.getElementById(`desc-short-${id}`); const f=document.getElementById(`desc-full-${id}`); const b=document.getElementById(`btn-read-${id}`); if(s.style.display=='none'){s.style.display='inline';f.style.display='none';b.innerText=getTrans('read_more');}else{s.style.display='none';f.style.display='inline';b.innerText=getTrans('show_less');} };
        window.handleProfileClick = handleProfileClick;
        function showLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; }
        function updateProfileIcon() { const i=document.getElementById('header-profile'); if(currentUser){i.classList.add('active');i.innerText=currentUser.displayName?currentUser.displayName.charAt(0).toUpperCase():'U';}else{i.classList.remove('active');i.innerHTML='<i class="fas fa-user"></i>';} }

        // --- FOOTER SECURITY (Tap 5 Times) ---
        let tapCount=0, tapTimer;
        document.getElementById('secret-footer-trigger').addEventListener('click', () => { 
            tapCount++; 
            clearTimeout(tapTimer); 
            tapTimer=setTimeout(()=>{tapCount=0},800); 
            if(tapCount===5){document.getElementById('password-modal').style.display='flex';tapCount=0;} 
        });
        
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('live-date').value = today;
        document.getElementById('event-date').value = today;
        document.getElementById('news-date').value = today;
        applyLanguage();
    </script>
</body>
</html>
